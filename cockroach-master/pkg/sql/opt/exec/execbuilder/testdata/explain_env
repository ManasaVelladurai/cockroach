# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO2zAUhq_xUxzlhnZraNLuAgVNWihByxZSlGYMhJDlOG7r4diV7bDANImH6BPyJFMCg15sbFzgC0s-5_9-_UfHrgsnTBuuZAATRS-1InR5sA-sYbSouSiZBsuMhat7FUKuC5opXTKNvykuDRa84haWxIBdMijZnNTCwhURNQvgXatnkhSC4Ru-uCGLjvqbXMlWr1aWV_yGaTxXmvGFxJfs2jzPsGbFNK-YtETgPxpgSgwlJfuH0RNbG4aX3Fi10KR6EVXVwnKqBDaW2JcEXxFtORGYy5I1zySdzxGaZFGYR5CH-0kEDfTQFoE4zXchneaQfkmSAdoqHir3r8k0neVZGKc5OCvNK6KvHTjO4qMwO4PP0Rn0CISzSX-AtuL0IDqFBheYlw30it_1w_AoTs428B4ZQNFH_T2EwiSPsoc87Z_ZWdWF4HSngTj9FE1ymOVhHs_yeDKD7XMEAPCju9vjUCXqShongPPHYtcgzuP7YrCh14xYVmJinQCckefvup7vej54fuB5gee97W5nAym5sVxSi6mqZYv5nrfR7naN27XZ6xVrXTdhWQvxCG5iWn1_MhyN_dG46_0c_PeExStO2AV6vSHRxfYeQtHpcRLGKfSmx_kAovSkD7MoaVf-Bg6z6RE08PVjlEVQwHsY7yHXdV1kKJHQfHj4Ywju1uu79e3d-haoksZqwqUNYDga-gGcD8fgwnB8gX4FAAD__0a8XCU=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ktFO2zAUhq_xUxzlhnZraNLuAgVNWihByxZSlGYMhJDlOG7r4diV7bDANImH6BPyJFMCg15sbFzgC0s-5_9-_UfHrgsnTBuuZAATRS-1InR5sA-sYbSouSiZBsuMhat7FUKuC5opXTKNvykuDRa84haWxIBdMijZnNTCwhURNQvgXatnkhSC4Ru-uCGLjvqbXMlWr1aWV_yGaTxXmvGFxJfs2jzPsGbFNK-YtETgPxpgSgwlJfuH0RNbG4aX3Fi10KR6EVXVwnKqBDaW2JcEXxFtORGYy5I1zySdzxGaZFGYR5CH-0kEDfTQFoE4zXchneaQfkmSAdoqHir3r8k0neVZGKc5OCvNK6KvHTjO4qMwO4PP0Rn0CISzSX-AtuL0IDqFBheYlw30it_1w_AoTs428B4ZQNFH_T2EwiSPsoc87Z_ZWdWF4HSngTj9FE1ymOVhHs_yeDKD7XMEAPCju9vjUCXqShongPPHYtcgzuP7YrCh14xYVmJinQCckefvup7vej54fuB5gee97W5nAym5sVxSi6mqZYv5nrfR7naN27XZ6xVrXTdhWQvxCG5iWn1_MhyN_dG46_0c_PeExStO2AV6vSHRxfYeQtHpcRLGKfSmx_kAovSkD7MoaVf-Bg6z6RE08PVjlEVQwHsY7yHXdV1kKJHQfHj4Ywju1uu79e3d-haoksZqwqUNYDga-gGcD8fgwnB8gX4FAAD__0a8XCU=

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9uq0YQxq-zTzHi5uAWjrHdiyOiSiXOuqV1cIRpmiiKVgus7W3wYu0uFFJVivoMvuzT-UkqsJOg5k9PLsLFSjvzfaMZzY-1bbhgUvFcuDDOk1uZ02R1egKsYklc8CxlEjRTGsq9CiHbBslymTJJfs-5UCTja65hRRXoFYOULWiRaShpVjAXvmv0TNA4Y-SOL-_osnW9Js9Fo883mq_5HZNkkUvGl4Lcslq97WHVhkm-ZkLTjLxYgCRUJTRl_1PoyVsoRlZc6Xwp6fpdrnWRaZ7kGVGa6vc0vqFSc5oRLlJWvdHpYoHQOMRehCHyTqYYKjDREQU_iL5AMIsg-HU6tdBRfIjsb-NZMI9Czw8iMDaSr6msDTgP_TMvvIJf8BWYFLz5uGehIz84xZdQkZjwtAIzfohPvDN_etWxm9SCuId6xwh50wiHh34aZj5vijjjyecK_OBnPI5gHnmRP4_88Rw-XSMAgD_bs_mMJM-KtVCGC9ePwTZBjcf7jdXRS0Y1SwnVhgvG0Bl8sZ2B7QzAGbiO4zrOt-1pdCwpV5qLRJMkL0RjGzhOJ93umjRr0_WGNVW7ZlFk2aOxa5P5H08Fh6PBcNTm_rK-esL4AydsG_q4IdHNp-P_oFg3KBbPUCzfiWLxgFxHurglJZFsQSqYzELs_xjstWUPQjzBIQ7GeA6VSZ8Qrkm5R7h8HeHCgvJthOsXEW5nx5fnU88PwJydRxbg4KIHczxttN_AJJydQWVBDb_9hEMMMXwPo2Nk27aNuBBM2u1jaCYyV6qHYLf9Z7e9323vQSVUQP0sUv1w-CWbzN_NBnbb7UGQ5EJpSbnQLvSH_YEL1_0R2NAf3aCObMEzzaQCU8uC9dC_AQAA___rPcR5

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lMFO204Qxs_sU4x8wfn_beRADyicTDCSW-Og2EUghFZre5JsWe9Gu2swVJV4iBz7dDxJZUNDpLa0HPBh5f3m-42-0Vj2fThDbbiSIxir8lorVi6ODgFbLIuGiwo1WDQWbp5chPg-aFS6Qk2_KC4NFbzmFhbMgF0gVDhjjbBww0SDI_jQ-VGyQiC95_N7Nu-pP9mV7PxqaXnN71HTmdLI55Je4515ncF2iZrXKC0T9LcNaMlMySr8S6MXtjFIF9xYNdesfhNVN8LyUglqLLNvCb5k2nImKJcVtq8knc0IGU-jMI8gDw-TCFpwyRaDOM33IZ3kkH5OEo9sFc_K0208SbN8GsZpDs5S85rpOwdOp_FJOL2AT9EFuAzCbDzwyFacHkXn0NKC8qoFt_ipH4cncXKxgbvMg2JABgeEhEkeTZ_zdN_MzrIpBC93WojTj9E4hywP8zjL43EG25cEAOBrf3aPUyrR1NI4I7hci32BOev7lbfh18gsVpRZZwTObjDc94OhHwwhGI6CYBQE__ens4FU3FguS0tL1cgOGwbBRrnfNe3WZu-W2HXdhGUjxBrcxLS6fWm4uzfc3etr37x_nrB4xwn7QO83JLnaPiAkOj9NwjgFd3KaexClZwPIoqRb-X9wPJ2cQAthBkqi9_Rmb9UB8X3fJ1xK1H7_S3BLrYwZEHhcfX9cPTyuHsCUTHbYL5q9VZ22etZmXFjUBlyrGxyQHwEAAP__LSBv1w==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 100

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1u2kwUhteZq3iVTcwnHBLxLSpQFo4ztG6NQfY0DYqi0WCPYYp_0Hhs2axyEVwhV1JRUvVHVaosZ_Q873mPdGwb91JXqixGcMt4o0sRr-9uIVsZL2uVJVLDyMqgOVGERJRBy1InUvOvpSoqnqlcGdzg-upqDNg2EpmKOjNoRFbLEf4ntg1ZiGUm-U6tdmL1XcRaVDBr-SdeFke-3BqVq53UPC21VKuCb2RXve7Idiu1ymVhRMb_GsBjUcUikf8I-unWleRrVZlypUX-JiuvM6PiMuOVEeYtxbdCGyUyropEtq80TVNC3JA6jII5tz5FB4uc1fAC9g7BjCH47Pt9cta8_Jxe7iyIWOh4AcP5Vqtc6O4c89CbOuECn-gCVg0ncnu_o-mGN1zLlLeYzELqvQ9ObNNDSCc0pIFLI7SWOHpecEcf0PGGq6SF1fzImzhTz1_8Mtaq-2h6pDcmxPEZDV_2ON7b5bZeZiq-7OAFH6nLEDGHeRHz3AgXj08XY0Low9x3vADWbM76oMF9DxH1j-x_mISzKTp8-UBDiho3GI6Jbds2qWJRoCM47PeH_fNh_4y4LCqjhSrMCIPrER4HQ9gYDJ_ItwAAAP__ttgCGA==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 100


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1u2kwUhteZq3iVTcwnHBLxLSpQFo4ztG6NQfY0DYqi0WCPYYp_0Hhs2axyEVwhV1JRUvVHVaosZ_Q873mPdGwb91JXqixGcMt4o0sRr-9uIVsZL2uVJVLDyMqgOVGERJRBy1InUvOvpSoqnqlcGdzg-upqDNg2EpmKOjNoRFbLEf4ntg1ZiGUm-U6tdmL1XcRaVDBr-SdeFke-3BqVq53UPC21VKuCb2RXve7Idiu1ymVhRMb_GsBjUcUikf8I-unWleRrVZlypUX-JiuvM6PiMuOVEeYtxbdCGyUyropEtq80TVNC3JA6jII5tz5FB4uc1fAC9g7BjCH47Pt9cta8_Jxe7iyIWOh4AcP5Vqtc6O4c89CbOuECn-gCVg0ncnu_o-mGN1zLlLeYzELqvQ9ObNNDSCc0pIFLI7SWOHpecEcf0PGGq6SF1fzImzhTz1_8Mtaq-2h6pDcmxPEZDV_2ON7b5bZeZiq-7OAFH6nLEDGHeRHz3AgXj08XY0Low9x3vADWbM76oMF9DxH1j-x_mISzKTp8-UBDiho3GI6Jbds2qWJRoCM47PeH_fNh_4y4LCqjhSrMCIPrER4HQ9gYDJ_ItwAAAP__ttgCGA==

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9q2zwYxo-rq3joSZ2Pun_odzASeuC6yubNdYqtdQ2lCMWWEy22FWTZ2DnqReQKcyUjTcc2CBs9lPj9nvd54XVdPEhTK10N4et0abRIF7c3kJ1MZ40qMmlgZW3R7ilCEspgpDaZNPy7VlXNC1Uqi2tcXlyMANdFJnPRFBatKBo5xP-vjqzErJB8reZrMX81cQ2d5wcVXRHXhV5ZVaq1NDzXRqp5xZeyr7EQNexCHnZkt5JGlbKyouAHA3gq6lRk8h9Bv9ymlnyhaqvnRpTvssqmsCrVBa-tsO8pvhLGKlFwVWWy-0vTPCfEj6nHKJh3E1L0cMhRgyBiHxBNGKKvYXhKjtq3n_3Ln0QJi70gYjheGVUK0x_jPg7uvHiKL3QKp4GX-IM_0XzJW25kzjuMJzENPkZ7th0gpmMa08inCTpH7LwguqWP6HnLVdbBaX_mjb27IJz-NtZpTtEOyGBEiBcyGr_tsbu5s1UzK1R61iOIPlOfIWEeCxIW-AlOnp5PRoTQx_vQCyI4k3t2Cho9DJDQcMf-h3E8uUOPb59oTNHgGlcj4rquS-pUVOgJtpvNdvOy3bwg1VVtjVCVHeL8coin8yu4OL96Jj8CAAD__21tAno=

statement ok
SET optimizer_foreign_keys = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0t9O2zAYBfBr_BRH3JBOhD9iF1MrLkJwt2whRYnHQAhZJnFajySubCdKuOIh-oQ8yUTLtCFVTLu0dX7Hn6XP93EljVW6GSPU-YPRIl-cn0H2Mr9vVVVIAyetQ7dJEZJRBiO1KaThP7VqLK9UrRxOcXx0NAF8H4UsRVs5dKJq5Rgf10Y24r6S_FHNH8V8LXEKXZZbiW7WRi-dqtWjNLzURqp5wx_kYN93vg_ZL6VRtWycqPjWDp4Lm4tCWiyEhVvI7UV_bGslXyjr9NyI-r9U3VZO5bri1gn3D_lm8KUwTomKq6aQ_TuTliUhYUoDRsGCs5higEd2WkQJ-4RkxpB8j-N9stO93mxO4SzJWBpECcPu0qhamGEXl2l0EaQ3-EZv4LUIsnD0Nlo-8I4bWfIe01lKo8_JJtuNkNIpTWkS0gy9J15clJzTawy846ro4XW_-6bBRRTf_PWs1-6jG5HRhJAgZjR9_cfL3h0s2_tK5QcDouQrDRkyFrAoY1GYYe_2bm9CCL2-jIMogTe7ZPugydUIGY1fsh8wTWcXGPDjC00pWpziZEJ83_eJzUWDgeB5tXpePT2vnpDrxjojVOPGODwe4_bwBD4OT-7IrwAAAP__XggC3A==

statement ok
SET experimental_optimizer_foreign_key_cascades = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0t9O2zAYBfBr_BRH3JBOhD9iF1MrLkJwt2whRYnHQAhZJnFajySubCdKuOIh-oQ8yUTLJJCYuktb53f8Wfp8H1fSWKWbMUKdPxgt8sX5GWQv8_tWVYU0cNI6dJsUIRllMFKbQhr-W6vG8krVyuEUx0dHE8D3UchStJVDJ6pWjvF5bWQj7ivJH9X8UczXEqfQZfkh0c3a6KVTtXqUhpfaSDVv-IMc7HYn-6U0qpaNExX_sITnwuaikFvKfP_NDK2VfKGs03MjaouFsHAL-T-qbiuncl1x64TbIt_NvhTGKVFx1RSyl_-WZUlImNKAUbDgLKYY4JGdFlHCviCZMSQ_43if7HSvN5tTOEsylgZRwrC7NKoWZtjFZRpdBOkNftAbeC2CLBy9j5YPvONGlrzHdJbS6GuyyXYjpHRKU5qENEPviRcXJef0GgPvuCp6eN3fvmlwEcU3b5712n10IzKaEBLEjKav_3jZvYNle1-p_GBAlHynIUPGAhZlLAoz7N3e7U0IodeXcRAl8GaXbB80uRoho_FL9hOm6ewCA359oylFi1OcTIjv-z6xuWgwEDyvVs-rp-fVE3LdWGeEatwYh8dj3B6ewMfhyR35EwAA__-l5wM-

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0t9O2zwYBvBjfBWPOCH9RPgjvoOpFQchuFu2kKLEYyCELJM4rUcSV7YTJRxxEb1CrmSiZdqYOrFDW8_vsV_p9X1cSWOVbsYIdf5gtMgX52eQvczvW1UV0sBJ69BtUoRklMFIbQpp-HetGssrVSuHUxwfHU0A30chS9FWDp2oWjnG_2sjG3FfSf6o5o9ivpY4hS7LrUQ3a6OXTtXqURpeaiPVvOEPcrDvO9kvpVG1bJyo-NYSngubi0L-Q9kv31rJF8o6PTeifkf6_h-wbiuncl1x64SzWAgLt5Db5Zv_L4VxSlRcNYXs5d9lWRISpjRgFCw4iykGeGSnRZSwD0hmDMnXON4nO93rzeYUzpKMpUGUMOwujaqFGXZxmUYXQXqDL_QGXosgC0dvo-UD77iRJe8xnaU0-phsst0IKZ3SlCYhzdB74sVFyTm9xsA7rooeXvezbxpcRPHNb8967T66ERlNCAliRtPXOV7272DZ3lcqPxgQJZ9pyJCxgEUZi8IMe7d3exNC6PVlHEQJvNkl2wdNrkbIaPyS_Q_TdHaBAd8-0ZSixSlOJsT3fZ_YXDQYCJ5Xq-fV0_PqCblurDNCNW6Mw-Mxbg9P4OPw5I78CAAA__8nJwOg

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0t9O2zwABfBr_BRH3JB-IvwR38XUiosQ3C1bSFHiMRBClkmc1iOJK9uJEq54iD4hTzK1ZdrQkNgubZ3fsY5k38eVNFbpZoxQ5w9Gi3xxfgbZy_y-VVUhDZy0Dt02RUhGGYzUppCGf9eqsbxStXI4xfHR0QTwfRSyFG3l0ImqlWP8vzGyEfeV5I9q_ijmG4lT6LJ8k-hmY_TSqVo9SsNLbaSaN_xBDvZ9J_ulNKqWjRMVf7OE58LmopB_UfbLt1byhbJOz42o_1nWbeVUritunXDvaN9_vWEpjFOi4qopZC8tFsLCLeQfsiwJCVMaMAoWnMUUAzyy0yJK2AckM4bkaxzvk53u5WZ7CmdJxtIgShh2l0bVwgy7uEyjiyC9wRd6A69FkIWj19HygXfcyJL3mM5SGn1MttluhJROaUqTkGboPbF2UXJOrzHwjquih9f97JsGF1F889uzXruPbkRGE0KCmNH0Zcf6Dx4s2_tK5QcDouQzDRkyFrAoY1GYYe_2bm9CCL2-jIMogTe7ZPugydUIGY3X2f8wTWcXGPDtE00pWpziZEJ83_eJzUWDgeB5tXpePT2vnpDrxjojVOPGODwe4_bwBD4OT-7IjwAAAP__6roEAg==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_foreign_keys

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyEjk9v1DAQR-_-FL8jICztn5YtXfUQgpFW2k1Lkq56s1xnkpg69tZ2qmU_PQo9UUq5jTTvzTzOsacQjXeXyL1-CF7p_usX0JH0_WhsQwGJYsLTM8VYJWoE8qGhIH9446K0ZjAJV5jPZmuAczTUqtEmPCk70iXOGOcgp-4tyZPpTqr7LaJXEamnl7h3E-8PyQzmREG2PpDpnHygn_ENZ-qi44GCGcglZeWrF6RWUauGIq7g2_bV3pcBYyTZm5h8F9TwVsJf1jDaZLS3MiaV_mP-0X5QIRllpXENHenfZtsylpciqwUq8f1WFLlApEfsNsU-294KzLHL7p7Hz4vFcrlazJafLs7PVqvzi9kKmyIvxU4UNeao6qysMV8zJu5uttmmwLvrm_ojRLF_j0psRV7jA76V17vpxZpxzjmL9DiS08QjWdJp2rBfAQAA__9MhcgW

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1upDYYvY6f4tPcLNPCBjK9WDGKVHbWaWknTAQ0u1EUWQZM4oaxR7ahTKpKqz7DXPbp8iQVTH5INjvtXoQLS_6-c47PJx_jOHDKlOZS-DCT-bWSNL_68B5Yy_Ks5lXBFBimDTRbFEIJTkExqQqmyO-SC00qvuQGDsFz3SmA40DBSlpXBhpa1cyHH5DjABM0qxi54Zc39LInwhXVYK7Yc7gUHV6uDF_yG6ZIKRXjl4Jcs7Xewel8sXbFFF8yYWhFXlQgOdU5LZiGQ5Bl-aLf5wZqzcgV10ZeKrrcZeEL1rKuDM9lRbSh5j-YT7yvqDKcVoSLgrXs68yyRGgW4yDFkAbv5xhasNAehTBK30G0SCH6bT630V52V9nuZosoSeMgjFIYrRRfUrUewUkcHgfxGfyKz8CiECSzsY32wugD_gQtyQgvWrCy-_pRcBzOzwZ0i9qQjdF4ilAwT3F856fLzttVnVU8f9tCGP2CZykkaZCGSRrOEnhzjgAA_uzX7hvlsqqXQo98OH8o9g06ethf2AO8YtSwglAz8mF04HrvHNdzXA9cz3dd33W_79fRgFJwbbjIDcllLTqa57qDdn_XpLs2s16xTnVIFnVVPRCHNCX_eBQ8mHgHk773l_2_J8xeccLe0OsNiS7eTJ9Fcd1Fsf4iis03RrG-j9wAWl6ThihWkhaOFjEOf4q22GYMMT7CMY5mOIHWoo8RXpNmG-Hm6xGubWh2R3j9YoSHs5-G-CM02-dgQ68IQQIJnne0xyocxYvjp8_DfnbUx59xjCGDQ5hMEcKfTuZBGIG1OEltwNHp-F70u61WM0WO4ziIC8GU0_9hrVxJrccIbjf_3G4-324-g86peHrOzm77493b71B_d1d9u9ncgXMptFGUC-PD_sG-58P5_gQc2J9coAGs5JVhSoNlVM3G6N8AAAD__86H5SY=
